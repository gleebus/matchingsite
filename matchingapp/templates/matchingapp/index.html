{% extends "matchingapp/base.html" %}

{% load staticfiles %}


{% block content %}
<div align="center">
    <h2>Filter users:</h2>
    <table id="filterTable">
        <tr>
            <input class="css-checkbox" type="checkbox" id="Male_chckbox" checked><label class="css-label" for="Male_chckbox">Male</label>
            <input class="css-checkbox" type="checkbox" id="Female_chckbox" checked><label class="css-label" for="Female_chckbox">Female</label>
            <input class="css-checkbox" type="checkbox" id="Other_chckbox" checked><label class="css-label" for="Other_chckbox">Other</label>
        </tr>
        <tr>
            <td>
                <p>
                <label for="age_range">Age range:</label>
                <input type="text" id="age_range" readonly style="border:0; color:#f6931f; font-weight:bold; height: 20px; width: 150px; font-size: 1em; text-align: center; color: #2196f3;">
                    </p>
                    
                    <div id="slider-range"></div>
                    </td>
        </tr>
        <tr>
            <td>
                <div align="center"><button id="filterBtn" onclick="updateList()">Filter</button></div>
            </td>
        </tr>
    </table>
</div>
<div align="center" id="usersDiv">
    <br/>
    <table id="usersTable">
        <tr id="usersTopRow">
            <th>Name</th>
            <th>Hobbies</th>
        </tr>
    </table>
</div>
{% endblock %}


{% block script %}
    <script>
        var profiles;
        var csrftoken = Cookies.get('csrftoken');
        var slider =  $("#slider-range");
        var age_range = $("#age_range");
        if ("{{ profile }}" === "{}")
        {
            window.location.pathname = '/profile/'
        }
        var profile = {{ profile|safe }};
        var hobbies = JSON.parse(profile.hobbies);
        $.ajax({
            url: '/getUsers',
            type: 'GET',
            beforeSend: function(xhr) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            },
            success: function (data) {
                profiles = data;
                var hobbies = JSON.parse(profile.hobbies);
                console.log(data);
                data.sort(function(a, b){
                    a = a.hobbies;
                    b = b.hobbies;
                    var aCom = 0;
                    var bCom = 0;
                    for (var i = 0; i < a.length; i++)
                    {
                        if (hobbies.indexOf(a[i])){
                            aCom++;
                        }
                    }
                    for (var i = 0; i < b.length; i++)
                    {
                        if (hobbies.indexOf(b[i])){
                            bCom++;
                        }
                    }
                    return bCom - aCom
                });
                console.log(data);
                for (var i = 0; i<data.length; i++){
                    document.getElementById('usersTable').innerHTML += "<tr id='pfl"+data[i].id+"'><td><a href=\"/profile/"+data[i].id+"\">" + data[i].name + "</a></td><td>" + data[i].hobbies.toString() + "</td></tr>"

                }
            },
            failure: function (data) {
                console.log(data);
            },
            error: function (data) {
                console.log(data);
            }
        });
          $( function() {
            slider.slider({
              range: true,
              min: 18,
              max: 99,
              values: [18, 99],
              slide: function( event, ui ) {
                age_range.val( ui.values[ 0 ] + " - " + ui.values[ 1 ] );
              }
            });
            age_range.val( slider.slider( "values", 0 ) +
              " - " + slider.slider( "values", 1 ) );
          } );

          function updateList() {
              console.log("Filtering");
              profiles.forEach(function (pfl) {
                  if ((pfl.age >= slider.slider("values", 0)) && (pfl.age <= slider.slider("values", 1)) && (document.getElementById(pfl.gender + '_chckbox').checked)) {
                    $('#pfl' + pfl.id).show();
                  } else {
                    $('#pfl' + pfl.id).hide();
                  }
              });
          }
    </script>
{% endblock %}
